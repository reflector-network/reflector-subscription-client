!function(A,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("@stellar/stellar-sdk")):"function"==typeof define&&define.amd?define(["@stellar/stellar-sdk"],t):"object"==typeof exports?exports.subscriptions=t(require("@stellar/stellar-sdk")):A.subscriptions=t(A["@stellar/stellar-sdk"])}(this,(A=>(()=>{"use strict";var t={346:t=>{t.exports=A}},e={};function r(A){var a=e[A];if(void 0!==a)return a.exports;var n=e[A]={exports:{}};return t[A](n,n.exports,r),n.exports}r.d=(A,t)=>{for(var e in t)r.o(t,e)&&!r.o(A,e)&&Object.defineProperty(A,e,{enumerable:!0,get:t[e]})},r.o=(A,t)=>Object.prototype.hasOwnProperty.call(A,t);var a={};r.d(a,{default:()=>g});var n=r(346);const i={0:"AlreadyInitialized",1:"Unauthorized",2:"SubscriptionNotFound",3:"NotInitialized",4:"InvalidAmount",5:"InvalidHeartbeat",6:"InvalidThreshold",7:"WebhookTooLong",8:"InvalidSubscriptionStatusError"};class o{constructor(A,t){this.id=A,this.status=0===t.status?"active":"suspended",this.owner=t.owner,this.base=l(t.base),this.quote=l(t.quote),this.threshold=t.threshold,this.heartbeat=t.heartbeat,this.balance=t.balance,this.updated=new Date(Number(t.updated))}id;status;owner;base;quote;threshold;heartbeat;webhook="[encrypted]";balance;updated}function s(A){return{asset:{tag:n.StrKey.isValidContract(A.symbol)?"Stellar":"Other",values:[A.symbol]},source:A.source}}function l(A){let t=A.asset.values[0];return"Stellar"===A.asset.tag&&(t=n.StrKey.encodeContract(t)),{source:A.source,symbol:t}}class c extends n.contract.Client{options;constructor(A){super(new n.contract.Spec(["AAAAAgAAAAAAAAAAAAAABUFzc2V0AAAAAAAAAgAAAAEAAAAAAAAAB1N0ZWxsYXIAAAAAAQAAABMAAAABAAAAAAAAAAVPdGhlcgAAAAAAAAEAAAAR","AAAAAQAAAAAAAAAAAAAAC1RpY2tlckFzc2V0AAAAAAIAAAAAAAAABWFzc2V0AAAAAAAH0AAAAAVBc3NldAAAAAAAAAAAAAAGc291cmNlAAAAAAAQ","AAAAAQAAAAAAAAAAAAAADFN1YnNjcmlwdGlvbgAAAAkAAAAAAAAAB2JhbGFuY2UAAAAABgAAAAAAAAAEYmFzZQAAB9AAAAALVGlja2VyQXNzZXQAAAAAAAAAAAloZWFydGJlYXQAAAAAAAAEAAAAAAAAAAVvd25lcgAAAAAAABMAAAAAAAAABXF1b3RlAAAAAAAH0AAAAAtUaWNrZXJBc3NldAAAAAAAAAAABnN0YXR1cwAAAAAH0AAAABJTdWJzY3JpcHRpb25TdGF0dXMAAAAAAAAAAAAJdGhyZXNob2xkAAAAAAAABAAAAAAAAAAHdXBkYXRlZAAAAAAGAAAAAAAAAAd3ZWJob29rAAAAAA4=","AAAABAAAAAAAAAAAAAAABUVycm9yAAAAAAAACQAAAAAAAAASQWxyZWFkeUluaXRpYWxpemVkAAAAAAAAAAAAAAAAAAxVbmF1dGhvcml6ZWQAAAABAAAAAAAAABRTdWJzY3JpcHRpb25Ob3RGb3VuZAAAAAIAAAAAAAAADk5vdEluaXRpYWxpemVkAAAAAAADAAAAAAAAAA1JbnZhbGlkQW1vdW50AAAAAAAABAAAAAAAAAAQSW52YWxpZEhlYXJ0YmVhdAAAAAUAAAAAAAAAEEludmFsaWRUaHJlc2hvbGQAAAAGAAAAAAAAAA5XZWJob29rVG9vTG9uZwAAAAAABwAAAAAAAAAeSW52YWxpZFN1YnNjcmlwdGlvblN0YXR1c0Vycm9yAAAAAAAI","AAAAAQAAAAAAAAAAAAAADkNvbnRyYWN0Q29uZmlnAAAAAAADAAAAAAAAAAVhZG1pbgAAAAAAABMAAAAAAAAAA2ZlZQAAAAAGAAAAAAAAAAV0b2tlbgAAAAAAABM=","AAAAAQAAAAAAAAAAAAAAFlN1YnNjcmlwdGlvbkluaXRQYXJhbXMAAAAAAAYAAAAAAAAABGJhc2UAAAfQAAAAC1RpY2tlckFzc2V0AAAAAAAAAAAJaGVhcnRiZWF0AAAAAAAABAAAAAAAAAAFb3duZXIAAAAAAAATAAAAAAAAAAVxdW90ZQAAAAAAB9AAAAALVGlja2VyQXNzZXQAAAAAAAAAAAl0aHJlc2hvbGQAAAAAAAAEAAAAAAAAAAd3ZWJob29rAAAAAA4=","AAAAAwAAAAAAAAAAAAAAElN1YnNjcmlwdGlvblN0YXR1cwAAAAAAAgAAAAAAAAAGQWN0aXZlAAAAAAAAAAAAAAAAAAlTdXNwZW5kZWQAAAAAAAAB","AAAAAAAAAAAAAAAGY29uZmlnAAAAAAABAAAAAAAAAAZjb25maWcAAAAAB9AAAAAOQ29udHJhY3RDb25maWcAAAAAAAA=","AAAAAAAAAAAAAAAHc2V0X2ZlZQAAAAABAAAAAAAAAANmZWUAAAAABgAAAAA=","AAAAAAAAAAAAAAAHdHJpZ2dlcgAAAAACAAAAAAAAAAl0aW1lc3RhbXAAAAAAAAAGAAAAAAAAAAx0cmlnZ2VyX2hhc2gAAAPuAAAAIAAAAAA=","AAAAAAAAAAAAAAAPdXBkYXRlX2NvbnRyYWN0AAAAAAEAAAAAAAAACXdhc21faGFzaAAAAAAAA+4AAAAgAAAAAA==","AAAAAAAAAAAAAAAGY2hhcmdlAAAAAAABAAAAAAAAABBzdWJzY3JpcHRpb25faWRzAAAD6gAAAAYAAAAA","AAAAAAAAAAAAAAATY3JlYXRlX3N1YnNjcmlwdGlvbgAAAAACAAAAAAAAABBuZXdfc3Vic2NyaXB0aW9uAAAH0AAAABZTdWJzY3JpcHRpb25Jbml0UGFyYW1zAAAAAAAAAAAABmFtb3VudAAAAAAABgAAAAEAAAPtAAAAAgAAAAYAAAfQAAAADFN1YnNjcmlwdGlvbg==","AAAAAAAAAAAAAAAHZGVwb3NpdAAAAAADAAAAAAAAAARmcm9tAAAAEwAAAAAAAAAPc3Vic2NyaXB0aW9uX2lkAAAAAAYAAAAAAAAABmFtb3VudAAAAAAABgAAAAA=","AAAAAAAAAAAAAAAGY2FuY2VsAAAAAAABAAAAAAAAAA9zdWJzY3JpcHRpb25faWQAAAAABgAAAAA=","AAAAAAAAAAAAAAAQZ2V0X3N1YnNjcmlwdGlvbgAAAAEAAAAAAAAAD3N1YnNjcmlwdGlvbl9pZAAAAAAGAAAAAQAAB9AAAAAMU3Vic2NyaXB0aW9u","AAAAAAAAAAAAAAAHbGFzdF9pZAAAAAAAAAAAAQAAAAY=","AAAAAAAAAAAAAAAFYWRtaW4AAAAAAAAAAAAAAQAAA+gAAAAT","AAAAAAAAAAAAAAAHdmVyc2lvbgAAAAAAAAAAAQAAAAQ=","AAAAAAAAAAAAAAADZmVlAAAAAAAAAAABAAAABg==","AAAAAAAAAAAAAAAFdG9rZW4AAAAAAAAAAAAAAQAAABM="]),A),this.options=A}fromJSON={config:this.txFromJSON,set_fee:this.txFromJSON,trigger:this.txFromJSON,update_contract:this.txFromJSON,charge:this.txFromJSON,create_subscription:this.txFromJSON,deposit:this.txFromJSON,cancel:this.txFromJSON,get_subscription:this.txFromJSON,admin:this.txFromJSON,version:this.txFromJSON,fee:this.txFromJSON,token:this.txFromJSON}}const d={validateRequired(A,t){if(!A)throw new TypeError(`Parameter "${t}" is required`);return A},validateNumber(A,t){if(this.validateRequired(A,t),"number"!=typeof A)throw new TypeError(`Parameter "${t}" - number expected`);return A},validateString(A,t){if(this.validateRequired(A,t),"string"!=typeof A||!A.length)throw new TypeError(`Parameter "${t}" - string expected`);return A},validateBigint(A,t){if(this.validateRequired(A,t),"bigint"!=typeof A)try{A=BigInt(A)}catch(A){throw new Error(`Invalid "${t}" value`)}if(A<=0n)throw new Error(`Invalid "${t}" value`);return A},validateOwner(A){if(this.validateString(A,"owner"),!n.StrKey.isValidEd25519PublicKey(A))throw new TypeError("Invalid owner account address");return A},validateOracle(A){if(this.validateString(A,"source"),!n.StrKey.isValidContract(A))throw new TypeError("Invalid oracle contract address");return A},validateBalance(A,t){return this.validateBigint(A,t)},validateOracleSymbol(A,t){return this.validateRequired(A,t),this.validateString(A.source,t+".source"),this.validateString(A.symbol,t+".symbol"),A},validateThreshold(A){if(this.validateNumber(A,"threshold"),A<1)throw new Error("Subscription threshold cannot be less than 1‰");if(A>1e4)throw new Error("Subscription threshold cannot be greater than 10,000‰");return Math.floor(A)},validateHeartbeat(A){if(this.validateNumber(A,"heartbeat"),A<5)throw new Error("Subscription heartbeat cannot be less than 5 minutes");if(A>60)throw new Error("Subscription heartbeat cannot be greater than 60 minutes");return Math.floor(A)},validateWebhook(A){if(this.validateString(A,"webhook"),!A.startsWith("https://")&&!A.startsWith("http://"))throw new TypeError("Only HTTP and HTTPS webhook URLs are supported");if(A.length>2e3)throw new TypeError("Webhook URL is too long");return A}},{subtle:u}=crypto,h=(new Uint8Array([1,0,1]),new TextEncoder);async function b(A,t){const e=crypto.getRandomValues(new Uint8Array(32)),r=crypto.getRandomValues(new Uint8Array(12)),a=await u.encrypt({name:"AES-GCM",iv:r},await(i=e,u.importKey("raw",p(i),{name:"AES-GCM"},!0,["encrypt","decrypt"])),p(t)),n=new Uint8Array(44);var i;n.set(e,0),n.set(r,32);const o=await u.encrypt({name:"RSA-OAEP"},A,n),s=new Uint8Array(256+a.byteLength);return s.set(new Uint8Array(o),0),s.set(new Uint8Array(a),256),s}function p(A){return"string"==typeof A?h.encode(A):A instanceof ArrayBuffer?new Uint8Array(A):A}const w="MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAyGCtE3dNoq53CkG9D3JtJig5f15hQsjL8fogRZQmZJqbGax8uJEVYCfJmvC5Qe9uVFf9rD1TJLmB/qonYOMTph929opC400fWXGvOSPtTNTvAUTSzKqfMPWN4KjyAvMZkm0dWac9ZQer4fI1M4TUbc4xFMbvM4mL0JlZw6Bo04iVpwxznHwNAT3or1Akh2qrYHkZdhPhewQ9sfmfiTt4/mrGidsGKzvCFjZ1UElBK8M7VL9oM/6BCiCEHDFrLepiS9A7gbMn247UJub/6hgjNvkV203rDgMhORwkaljY+dAC9DWLX06D3lVYEVzeEK8uFcIDDyQ8wb/q6imLqR5bcwIDAQAB";let m;async function y(A){return m||(m=await function(A){let t="pkcs8",e="decrypt";return(A=p(A)).length<500&&(t="spki",e="encrypt"),u.importKey(t,A,{name:"RSA-OAEP",hash:"SHA-256"},!0,[e])}(function(A){const t=atob(A),e=new Uint8Array(t.length);for(let A=0;A<t.length;A++)e[A]=t.charCodeAt(A);return e}(w))),b(m,A)}function v(A){if(A.simulation.error){const t=/HostError: Error\(Contract, #(\d+)\)/.exec(A.simulation.error);throw t?new Error("Contract execution error: "+i[t[1]]):A.simulation.error}}class g{constructor(A){const t={publicKey:A.publicKey,signTransaction:A.signTransaction,rpcUrl:A.rpcUrl,networkPassphrase:n.Networks.TESTNET,contractId:A.contractId||"CCPYWKODBPDCHCYJTQ3S5OSLXB6LAXQWN6FEOYUYMWXCX2ESYLHPAYMW"};this.client=new c(t)}client;async getSubscription(A){A=d.validateBigint(A,"subscriptionId");const t=await this.client.get_subscription({subscription_id:A});return v(t),new o(A,t.result)}async createSubscription(A){let{owner:t=this.client.options.publicKey,base:e,quote:r,threshold:a,heartbeat:n,webhook:i,initialBalance:l}=A;if(d.validateOwner(t),d.validateOracleSymbol(e,"base"),d.validateOracleSymbol(r,"quote"),e.source!==r.source)throw new Error("Cross-oracle subscriptions not supported");a=d.validateThreshold(a),n=d.validateHeartbeat(n),d.validateWebhook(i),l=d.validateBalance(l,"initialBalance");const c=await y(i),u=await this.client.create_subscription({new_subscription:{owner:t,base:s(e),quote:s(r),heartbeat:n,threshold:a,webhook:c},amount:l});v(u);const h=await u.signAndSend();return new o(h.result[0],h.result[1])}async deposit(A,t,e){A=d.validateBigint(A,"subscriptionId"),t=d.validateBigint(t,"amountToDeposit");const r=await this.client.deposit({subscription_id:A,amount:t,from:e});v(r),await r.signAndSend()}async cancel(A){A=d.validateBigint(A,"subscriptionId");const t=await this.client.cancel({subscription_id:A});v(t),await t.signAndSend()}async getToken(){const A=await this.client.token();return v(A),A.result}async getVersion(){const A=await this.client.version();return v(A),A.result}async getFee(){const A=await this.client.version();return v(A),A.result}}return a.default})()));
//# sourceMappingURL=subscriptions.js.map